<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - University Football Tournament</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
    <!-- Data Functions -->
    <script src="js/data.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand animate__animated animate__pulse animate__infinite" href="index.html">Football Tournament</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="players.html">Players</a></li>
                    <li class="nav-item"><a class="nav-link" href="teams.html">Teams</a></li>
                    <li class="nav-item"><a class="nav-link" href="auction.html">Auction</a></li>
                    <li class="nav-item"><a class="nav-link" href="schedule.html">Schedule</a></li>
                    <li class="nav-item"><a class="nav-link" href="points-table.html">Points Table</a></li>
                    <li class="nav-item"><a class="nav-link" href="results.html">Results</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Login Form -->
    <div id="login-form" class="container my-5">
        <h2 class="text-center">Admin Login</h2>
        <div class="form-group">
            <label for="admin-email">Email:</label>
            <input type="email" id="admin-email" class="form-control" placeholder="admin@tournament.com" required>
        </div>
        <div class="form-group">
            <label for="admin-password">Password:</label>
            <input type="password" id="admin-password" class="form-control" placeholder="Password" required>
        </div>
        <button id="login-btn" class="btn btn-primary mt-2">Login</button>
        <p id="login-error" class="text-danger mt-2"></p>
    </div>

    <!-- Admin Content (Hidden Initially) -->
    <div id="admin-content" style="display: none;">
        <!-- Logout Button -->
        <div class="container my-3 text-end">
            <button id="logout-btn" class="btn btn-danger">Logout</button>
        </div>

        <!-- Admin Panel Content -->
        <div class="container my-5">
            <div id="error" class="alert alert-danger" style="display: none;"></div>

            <h2 class="text-center">Manage Players</h2>
            <form id="player-form">
                <input type="hidden" id="player-id">
                <div class="form-group">
                    <label for="player-name">Player Name:</label>
                    <input type="text" id="player-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="player-regNum">Registration Number:</label>
                    <input type="text" id="player-regNum" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="player-position">Position:</label>
                    <select id="player-position" class="form-control" required>
                        <option value="Forward">Forward</option>
                        <option value="Midfielder">Midfielder</option>
                        <option value="Defender">Defender</option>
                        <option value="Goalkeeper">Goalkeeper</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="player-image">Image URL:</label>
                    <input type="url" id="player-image" class="form-control">
                </div>
                <button type="submit" id="player-submit" class="btn btn-primary">Add Player</button>
            </form>
        </div>

        <div class="container my-5">
            <h2 class="text-center">Players List</h2>
            <div id="admin-players-list" class="row"></div>
        </div>

        <div class="container my-5">
            <h2 class="text-center">Manage Teams</h2>
            <form id="team-form">
                <input type="hidden" id="team-id">
                <div class="form-group">
                    <label for="team-name">Team Name:</label>
                    <input type="text" id="team-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="team-manager">Manager:</label>
                    <input type="text" id="team-manager" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="team-owner">Owner:</label>
                    <input type="text" id="team-owner" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="team-logo">Logo URL:</label>
                    <input type="url" id="team-logo" class="form-control">
                </div>
                <div class="form-group">
                    <label for="team-group">Group:</label>
                    <select id="team-group" class="form-control" required>
                        <option value="A">Group A</option>
                        <option value="B">Group B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="team-players">Players:</label>
                    <select id="team-players" class="form-control player-select" multiple></select>
                </div>
                <button type="submit" id="team-submit" class="btn btn-primary">Add Team</button>
            </form>
        </div>

        <div class="container my-5">
            <h2 class="text-center">Teams List</h2>
            <div id="admin-teams-list" class="row"></div>
        </div>

        <div class="container my-5">
            <h2 class="text-center">Manage Schedule</h2>
            <form id="schedule-form">
                <input type="hidden" id="schedule-id">
                <div class="form-group">
                    <label for="schedule-team1">Team 1:</label>
                    <select id="schedule-team1" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="schedule-team2">Team 2:</label>
                    <select id="schedule-team2" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="schedule-date">Date:</label>
                    <input type="date" id="schedule-date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="schedule-time">Time:</label>
                    <input type="time" id="schedule-time" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="schedule-location">Location:</label>
                    <input type="text" id="schedule-location" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="schedule-status">Status:</label>
                    <select id="schedule-status" class="form-control" required>
                        <option value="Scheduled">Scheduled</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div id="score-fields" style="display: none;">
                    <div class="form-group">
                        <label for="schedule-team1-score">Team 1 Score:</label>
                        <input type="number" id="schedule-team1-score" class="form-control" min="0">
                    </div>
                    <div class="form-group">
                        <label for="schedule-team2-score">Team 2 Score:</label>
                        <input type="number" id="schedule-team2-score" class="form-control" min="0">
                    </div>
                </div>
                <button type="submit" id="schedule-submit" class="btn btn-primary">Add Match</button>
            </form>
        </div>

        <div class="container my-5">
            <h2 class="text-center">Schedule List</h2>
            <div id="admin-schedule-list" class="row"></div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script>
        // DOM Elements
        const playerForm = document.getElementById('player-form');
        const teamForm = document.getElementById('team-form');
        const scheduleForm = document.getElementById('schedule-form');
        const playerSubmit = document.getElementById('player-submit');
        const teamSubmit = document.getElementById('team-submit');
        const scheduleSubmit = document.getElementById('schedule-submit');
        const errorDiv = document.getElementById('error');
        const loginError = document.getElementById('login-error');
    
        // Firebase Authentication State Listener
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                // User is logged in, show admin panel
                document.getElementById('admin-content').style.display = 'block';
                document.getElementById('login-form').style.display = 'none';
                initializeAdminPanel();
            } else {
                // User is not logged in, show login form
                document.getElementById('admin-content').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            }
        });
    
        // Login Button Handler
        document.getElementById('login-btn').addEventListener('click', () => {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            if (!email || !password) {
                loginError.textContent = 'Please enter both email and password.';
                return;
            }
            firebase.auth().signInWithEmailAndPassword(email, password)
                .catch(err => {
                    loginError.textContent = 'Login failed: ' + err.message;
                });
        });
    
        // Logout Button Handler
        document.getElementById('logout-btn').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.reload(); // Refresh to show login form
            });
        });
    
        // Initialize Admin Panel
        async function initializeAdminPanel() {
            try {
                // Initial render for players and teams
                await Promise.all([
                    renderAdminPlayers(),
                    renderAdminTeams(),
                    populatePlayerSelect(),
                    populateTeamSelects()
                ]);
    
                // Set up real-time listener for schedule
                db.collection('schedule').onSnapshot(snapshot => {
                    const schedule = snapshot.docs.map(doc => ({ id: parseInt(doc.id), ...doc.data() }));
                    renderAdminSchedule(schedule.sort((a, b) => a.id - b.id));
                }, err => {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Error listening to schedule: ' + err.message;
                });
            } catch (err) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error loading admin panel: ' + err.message;
            }
        }
    
        // Render admin lists
        async function renderAdminPlayers() {
            const container = document.getElementById('admin-players-list');
            const players = await getPlayers();
            container.innerHTML = '';
            players.forEach(player => {
                container.innerHTML += `
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <img src="${player.image}" class="card-img-top" alt="${player.name}">
                            <div class="card-body">
                                <h5 class="card-title">${player.name}</h5>
                                <p class="player-position">${player.position}</p>
                                <p class="card-text">Reg: ${player.regNum}</p>
                                <button class="btn btn-warning btn-sm edit-player" data-regnum="${player.regNum}" aria-label="Edit player ${player.name}">Edit</button>
                                <button class="btn btn-danger btn-sm delete-player" data-regnum="${player.regNum}" aria-label="Delete player ${player.name}">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
    
            // Attach event listeners directly
            document.querySelectorAll('.edit-player').forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log(`Edit player clicked: ${btn.dataset.regnum}`);
                    editPlayer(btn.dataset.regnum);
                });
            });
            document.querySelectorAll('.delete-player').forEach(btn => {
                btn.addEventListener('click', async () => {
                    console.log(`Delete player clicked: ${btn.dataset.regnum}`);
                    await deletePlayer(btn.dataset.regnum);
                });
            });
        }
    
        async function renderAdminTeams() {
            const container = document.getElementById('admin-teams-list');
            const teams = await getTeams();
            const players = await getPlayers();
            container.innerHTML = '';
            teams.forEach(team => {
                const teamPlayers = players.filter(p => team.playerRegNums.includes(p.regNum));
                const playerNames = teamPlayers.map(p => `${p.name} (${p.position})`).join(', ');
                container.innerHTML += `
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <img src="${team.logo}" class="card-img-top" alt="${team.name}">
                            <div class="card-body">
                                <h5 class="card-title">${team.name}</h5>
                                <p class="card-text">
                                    Manager: ${team.manager}<br>
                                    Owner: ${team.owner}<br>
                                    Players: ${playerNames || 'None'}
                                </p>
                                <button class="btn btn-warning btn-sm edit-team" data-id="${team.id}" aria-label="Edit team ${team.name}">Edit</button>
                                <button class="btn btn-danger btn-sm delete-team" data-id="${team.id}" aria-label="Delete team ${team.name}">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
    
            // Attach event listeners directly with debug logs
            const editButtons = document.querySelectorAll('.edit-team');
            const deleteButtons = document.querySelectorAll('.delete-team');
            console.log(`Found ${editButtons.length} edit buttons and ${deleteButtons.length} delete buttons`);
    
            editButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log(`Edit team clicked: ${btn.dataset.id}`);
                    editTeam(btn.dataset.id);
                });
            });
    
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    console.log(`Delete team clicked: ${btn.dataset.id}`);
                    await deleteTeam(parseInt(btn.dataset.id));
                });
            });
        }
    
        function renderAdminSchedule(schedule) {
            const container = document.getElementById('admin-schedule-list');
            container.innerHTML = '';
            schedule.forEach(match => {
                const scoreDisplay = match.score ? `${match.teams[0]} ${match.score[match.teams[0]]} - ${match.score[match.teams[1]]} ${match.teams[1]}` : 'Not yet played';
                container.innerHTML += `
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${match.teams[0]} vs ${match.teams[1]}</h5>
                                <p class="card-text">
                                    Date: ${match.date}<br>
                                    Time: ${match.time}<br>
                                    Location: ${match.location}<br>
                                    Status: ${match.status}<br>
                                    Score: ${scoreDisplay}
                                </p>
                                <button class="btn btn-warning btn-sm edit-schedule" data-id="${match.id}" aria-label="Edit schedule for ${match.teams[0]} vs ${match.teams[1]}">Edit</button>
                                <button class="btn btn-danger btn-sm delete-schedule" data-id="${match.id}" aria-label="Delete schedule for ${match.teams[0]} vs ${match.teams[1]}">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
    
            // Attach event listeners directly
            document.querySelectorAll('.edit-schedule').forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log(`Edit schedule clicked: ${btn.dataset.id}`);
                    editSchedule(btn.dataset.id);
                });
            });
            document.querySelectorAll('.delete-schedule').forEach(btn => {
                btn.addEventListener('click', async () => {
                    console.log(`Delete schedule clicked: ${btn.dataset.id}`);
                    await deleteSchedule(parseInt(btn.dataset.id));
                });
            });
        }
    
        // Populate team selects
        async function populateTeamSelects() {
            const team1Select = document.getElementById('schedule-team1');
            const team2Select = document.getElementById('schedule-team2');
            const teams = await getTeams();
            team1Select.innerHTML = '<option value="">Select Team</option>';
            team2Select.innerHTML = '<option value="">Select Team</option>';
            teams.forEach(team => {
                team1Select.innerHTML += `<option value="${team.name}">${team.name}</option>`;
                team2Select.innerHTML += `<option value="${team.name}">${team.name}</option>`;
            });
        }
    
        // Populate player select
        async function populatePlayerSelect(selectedRegNums = []) {
            const playerSelect = document.getElementById('team-players');
            const players = await getPlayers();
            playerSelect.innerHTML = '';
            players.forEach(player => {
                const isSelected = selectedRegNums.includes(player.regNum) ? 'selected' : '';
                playerSelect.innerHTML += `<option value="${player.regNum}" ${isSelected}>${player.name} (${player.position})</option>`;
            });
        }
    
        // Player form handling
        playerForm.addEventListener('submit', async e => {
            e.preventDefault();
            const regNum = document.getElementById('player-id').value || document.getElementById('player-regNum').value;
            const player = {
                name: document.getElementById('player-name').value,
                regNum: document.getElementById('player-regNum').value,
                position: document.getElementById('player-position').value,
                image: document.getElementById('player-image').value || 'https://via.placeholder.com/200'
            };
    
            try {
                if (regNum && regNum !== player.regNum) {
                    // If regNum is being edited, delete the old document and create a new one
                    await removePlayer(regNum);
                    await addPlayer(player);
                } else if (regNum) {
                    await updatePlayer(regNum, player);
                } else {
                    await addPlayer(player);
                }
                playerSubmit.textContent = 'Add Player';
                document.getElementById('player-id').value = '';
                playerForm.reset();
                await renderAdminPlayers();
                await populatePlayerSelect();
            } catch (err) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error saving player: ' + err.message;
            }
        });
    
        function editPlayer(regNum) {
            getPlayers().then(players => {
                const player = players.find(p => p.regNum === regNum);
                if (player) {
                    document.getElementById('player-name').value = player.name;
                    document.getElementById('player-regNum').value = player.regNum;
                    document.getElementById('player-position').value = player.position;
                    document.getElementById('player-image').value = player.image;
                    document.getElementById('player-id').value = player.regNum;
                    playerSubmit.textContent = 'Update Player';
                } else {
                    console.error(`Player with regNum ${regNum} not found`);
                }
            });
        }
    
        async function deletePlayer(regNum) {
            try {
                await removePlayer(regNum);
                await renderAdminPlayers();
                await populatePlayerSelect();
            } catch (err) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error deleting player: ' + err.message;
            }
        }
    
        // Team form handling
        teamForm.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('team-id').value ? parseInt(document.getElementById('team-id').value) : null;
            const playerSelect = document.getElementById('team-players');
            const selectedPlayerRegNums = Array.from(playerSelect.selectedOptions).map(opt => opt.value);
            const team = {
                name: document.getElementById('team-name').value,
                manager: document.getElementById('team-manager').value,
                owner: document.getElementById('team-owner').value,
                logo: document.getElementById('team-logo').value || 'https://via.placeholder.com/60',
                playerRegNums: selectedPlayerRegNums,
                group: document.getElementById('team-group').value // Add group field
            };
    
            try {
                if (id) {
                    await updateTeam(id, team);
                    teamSubmit.textContent = 'Add Team';
                    document.getElementById('team-id').value = '';
                } else {
                    await addTeam(team);
                }
                teamForm.reset();
                await renderAdminTeams();
                await populateTeamSelects();
                await populatePlayerSelect();
            } catch (err) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error saving team: ' + err.message;
            }
        });
    
        function editTeam(id) {
            getTeams().then(teams => {
                const team = teams.find(t => t.id === parseInt(id));
                if (team) {
                    document.getElementById('team-name').value = team.name;
                    document.getElementById('team-manager').value = team.manager;
                    document.getElementById('team-owner').value = team.owner;
                    document.getElementById('team-logo').value = team.logo;
                    document.getElementById('team-id').value = team.id;
                    document.getElementById('team-group').value = team.group || 'A'; // Default to Group A if not set
                    populatePlayerSelect(team.playerRegNums || []);
                    teamSubmit.textContent = 'Update Team';
                } else {
                    console.error(`Team with ID ${id} not found`);
                }
            });
        }
    
        async function deleteTeam(id) {
            try {
                await removeTeam(id);
                await renderAdminTeams();
                await populateTeamSelects();
            } catch (err) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error deleting team: ' + err.message;
            }
        }
    
        // Schedule form handling
        scheduleForm.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('schedule-id').value ? parseInt(document.getElementById('schedule-id').value) : null;
            const match = {
                teams: [
                    document.getElementById('schedule-team1').value,
                    document.getElementById('schedule-team2').value
                ],
                date: document.getElementById('schedule-date').value,
                time: document.getElementById('schedule-time').value,
                location: document.getElementById('schedule-location').value,
                status: document.getElementById('schedule-status').value
            };
    
            // Add score if the match is completed
            if (match.status === 'Completed') {
                const team1Score = parseInt(document.getElementById('schedule-team1-score').value) || 0;
                const team2Score = parseInt(document.getElementById('schedule-team2-score').value) || 0;
                match.score = {
                    [match.teams[0]]: team1Score,
                    [match.teams[1]]: team2Score
                };
            }
    
            try {
                if (match.teams[0] === match.teams[1]) {
                    throw new Error("Teams cannot be the same!");
                }
                if (id) {
                    await updateSchedule(id, match);
                    scheduleSubmit.textContent = 'Add Match';
                    document.getElementById('schedule-id').value = '';
                } else {
                    await addSchedule(match);
                }
                scheduleForm.reset();
            } catch (err) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error saving match: ' + err.message;
            }
        });
    
        function editSchedule(id) {
            getSchedule().then(schedule => {
                const match = schedule.find(s => s.id === parseInt(id));
                if (match) {
                    document.getElementById('schedule-team1').value = match.teams[0];
                    document.getElementById('schedule-team2').value = match.teams[1];
                    document.getElementById('schedule-date').value = match.date;
                    document.getElementById('schedule-time').value = match.time;
                    document.getElementById('schedule-location').value = match.location;
                    document.getElementById('schedule-status').value = match.status;
                    document.getElementById('schedule-team1-score').value = match.score ? match.score[match.teams[0]] : '';
                    document.getElementById('schedule-team2-score').value = match.score ? match.score[match.teams[1]] : '';
                    document.getElementById('schedule-id').value = match.id;
                    scheduleSubmit.textContent = 'Update Match';
                    toggleScoreFields(match.status === 'Completed');
                } else {
                    console.error(`Schedule with ID ${id} not found`);
                }
            });
        }
    
        function toggleScoreFields(isCompleted) {
            const scoreFields = document.getElementById('score-fields');
            if (isCompleted) {
                scoreFields.style.display = 'block';
            } else {
                scoreFields.style.display = 'none';
                document.getElementById('schedule-team1-score').value = '';
                document.getElementById('schedule-team2-score').value = '';
            }
        }
    
        // Update score fields visibility when status changes
        document.getElementById('schedule-status').addEventListener('change', (e) => {
            toggleScoreFields(e.target.value === 'Completed');
        });
    
        async function deleteSchedule(id) {
            try {
                await removeSchedule(id);
            } catch (err) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error deleting schedule: ' + err.message;
            }
        }
    </script>
</body>
</html>